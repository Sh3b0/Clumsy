---
title: Logging and Auditing
---


### Part 1: journald

- Journald rate limits log messages and will drop all messages from a service if it passes certain limits. These limits can be configured via `RateLimitBurst` and `RateLimitIntervalSec`, which default to 10000 and 30s respectively. The rate limiting feature is very handy when you have services that generate a lot of logs.

  ```execute
  cat /etc/systemd/journald.conf | grep RateLimit
  ```

- `journalctl` is the main tool for interacting with the journal. Run this tool `journalctl`

- View all the options you can use with journalctl.

  ```execute
  man journalctl
  ```

- Show only the last 10 lines of the journal with the `-n` option

  ```execute
  journalctl -n 10
  ```

- Follow the logs with the `-f` option.

  ```execute
  journalctl -f
  ```

- View the journal in reverse order. From the newest to the oldest.

  ```execute
  journalctl --reverse
  ```

- The `--output` in journalctl can be used to format the output of the journal in various forms.

- View the journal in json format with the option `--output=json-pretty` or just `--output=json`. If you want it compact, use

  ```execute
  journalctl --output=json-pretty
  ```

- Filter journal for specific systemd unit with the command `journalctl -u <systemd-unit>`.

  ```execute
  journalctl -u multiuser.target
  ```

- You can also filter with the `-p` option to specify event severity levels that should be displayed.

- Show only kernel messages.

  ```execute
  journalctl --dmesg
  ```

- You can filter by time with the `--since` and `--until` options.

  ```execute
  journalctl --since="2022-10-30 23:00:00"
  ```

  OR
  ```execute
  journalctl --since=yesterday --until=now
  ```

- You can view the time that the system was reboot in the journal

  ```execute
  journalctl MESSAGE="Server listening on 0.0.0.0 port 22."
  ```

### Part 2: rsyslog

- Use the `logger` utility to generate logs.

  ```execute
  logger Test
  ```

- View the log in `/varlog/syslog`

  ```execute
  tail /var/log/syslog
  ```

- You should see a line of log similar to the following.

  ```
  Oct 30 02:06:04 <hostname> root: Test
  ```

- Rsyslog rules typically have the facility and the level. These two combined in the form `facility.level` define the priority of the log message.
  - More about facility and level: https://success.trendmicro.com/dcx/s/solution/TP000086250

- Create an rsyslog rule that stores all logs with `user.emerg` priority to a log file `/var/log/test.log`. Do this by adding the following rule to `/etc/rsyslog.conf`

  ```copy
  user.emerg /var/log/test.log
  ```

- Restart rsyslog to apply the changes.

  ```execute
  systemctl restart rsyslog
  ```

- Follow the logs from the file:

  ```execute
  tail -f /var/log/test.log
  ```

- Open a new terminal in another tab where you will run the `logger` utility to test this rule and execute the following command.

  ```execute
  logger -p user.emerg "test log"
  ```

- Go to the previous terminal tab, you should see the log appear.


### Part 3: User authentication activities

- System login activity are saved in the log file `/var/log/auth.log`. You can see user sessions opened and other events such as authentication failure.

- Let’s create a new user `testuser` which we will use to simulate failed login.

  ```execute
  sudo adduser testuser
  ```

- Try switching to the `testuser` with `su` command. Enter a wrong password on the prompt.

  ```
  su testuser
  Password: 
  su: Authentication failure
  ```

- Check the log file `/var/log/auth.log`  to view this failed login activity.

  ```execute
  tail /var/log/auth.log
  ```

  You should see lines of log similar to the following two. These are the failed login events.

  ```
  Oct 30 20:03:07 <hostname> su: pam_unix(su:auth): authentication failure; logname= uid=1000 euid=0 tty=/dev/pts/0 ruser=user1 rhost=  user=testuser
  Oct 30 20:03:09 <hostname> su: FAILED SU (to testuser) user1 on pts/0
  ```

- Try switching to the `root` user. This time, enter three consecutive wrong passwords in the prompt.

  ```
  $ sudo su
  [sudo] password for user1: 
  Sorry, try again.
  [sudo] password for user1: 
  Sorry, try again.
  [sudo] password for user1: 
  sudo: 3 incorrect password attempts
  ```

- View the authentication log file again.

  ```execute
  tail /var/log/auth.log
  ```

- You should see the following lines in the output.

  ```
  Oct 30 20:09:05 <hostname> sudo: pam_unix(sudo:auth): authentication failure; logname= uid=1000 euid=0 tty=/dev/pts/1 ruser=user1 rhost=  user=user1
  Oct 30 20:09:13 <hostname> sudo:    user1 : 3 incorrect password attempts ; TTY=pts/1 ; PWD=/home/user1 ; USER=root ; COMMAND=/usr/bin/su
  ```

- The audit log file contains several other events. We can filter for failed log in attempts with the text filtering editors.

  ```execute
  cat /var/log/auth.log | grep -P "(?i)authentication failure|incorrect password"
  ```

- `journalctl` can also display such logs. Let’s run `journalctl` and filter for authentication failure.

  ```execute
  journalctl | grep -P "(?i)authentication failure|incorrect password"
  ```

- Create a script that automatically extracts these failed authentication logs and save them to another file. This makes it easier to quickly detect security violations. Create a script `track_auth_fail.sh` with the following content:

  ```copy
  #!/bin/bash
  
  tail -n0 -f /var/log/auth.log | \
  grep -P --line-buffered "authentication failure|incorrect password" |\
  tee /var/log/failed_auth.log
  ```

- Run the script in the background and suppress it’s output.

  ```execute
  sudo bash track_auth_fail.sh > /dev/null 2>&1 &
  ```

- Simulate a failed login for `testuser`

  ```
  $ su testuser
  Password: 
  su: Authentication failure
  ```

- Check the new log file with `tail /var/log/failed_auth.log` and you should see log similar to the following:

  ```
  Oct 30 21:15:37 sna-vm su: pam_unix(su:auth): authentication failure; logname= uid=1000 euid=0 tty=/dev/pts/0 ruser=user1 rhost=  user=testuser
  ```
